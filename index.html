<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnny3x Bounty System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a; /* Deep dark background */
            color: #e0e0e0;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1a1a1a; /* Darker modal background */
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            border: 1px solid #4a0000; /* Red border for modals */
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* Hide number input arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <header class="text-center mb-8">
        <h1 class="text-5xl font-extrabold text-red-500 mb-4 text-glow">Johnny3x Rust Bounty System</h1>
        <p class="text-xl text-gray-400">Track and manage bounties on your favorite players.</p>
    </header>

    <div id="message-container"
        class="hidden fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg text-white font-bold z-50 transition-all duration-300 ease-in-out shadow-lg">
    </div>

    <main class="max-w-6xl mx-auto p-8 bg-gray-900 rounded-xl shadow-2xl border border-red-800">
        <div id="loading-indicator" class="text-center py-10">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500 mx-auto mb-4"></div>
            <p class="text-gray-400 text-lg">Loading Bounties...</p>
        </div>

        <div id="main-content" class="hidden">
            <section class="mb-8 p-6 bg-gray-950 rounded-lg border border-red-700 shadow-inner">
                <h2 class="text-2xl font-bold text-red-400 mb-4">Account Status</h2>
                <div id="user-login-status" class="flex flex-col md:flex-row items-center justify-between">
                    </div>
            </section>

            <section id="authenticated-sections" class="hidden mb-10 p-8 bg-gray-950 rounded-lg border border-red-700 shadow-inner">
                <h2 class="text-2xl font-bold text-red-400 mb-6 text-center">Add New Bounty</h2>
                <form id="add-bounty-form" class="space-y-4">
                    <div>
                        <label for="targetPlayer" class="block text-gray-300 text-sm font-bold mb-2">
                            Target Player Name:
                        </label>
                        <input type="text" id="targetPlayer"
                            class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                            required />
                    </div>
                    <div>
                        <label for="amount" class="block text-gray-300 text-sm font-bold mb-2">
                            Bounty Amount:
                        </label>
                        <input type="number" id="amount" min="1"
                            class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                            required />
                    </div>
                    <div>
                        <label for="rewardType" class="block text-gray-300 text-sm font-bold mb-2">
                            Reward Type:
                        </label>
                        <input type="text" id="rewardType"
                            class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                            placeholder="What are you rewarding (USD, Scrap, JohnnyCoin etc.)"
                            required />
                    </div>
                    <div>
                        <label for="reason" class="block text-gray-300 text-sm font-bold mb-2">
                            Reason for Bounty:
                        </label>
                        <textarea id="reason" rows="3"
                            class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600 resize-y"
                            required></textarea>
                    </div>
                    <div>
                        <label for="paymentMethod" class="block text-gray-300 text-sm font-bold mb-2">
                            Preferred Payment Method:
                        </label>
                        <select id="paymentMethod"
                            class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600">
                            <option value="In-game Items">In-game Items</option>
                            <option value="Johnny Coins">Johnny Coins</option>
                            <option value="IRL Payments">IRL Payments</option>
                        </select>
                    </div>
                    <div class="flex justify-center">
                        <button type="submit"
                            class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            Post New Bounty
                        </button>
                    </div>
                </form>
            </section>

            <section class="mb-10 p-8 bg-gray-950 rounded-lg border border-red-700 shadow-inner">
                <h2 class="text-2xl font-bold text-red-400 mb-6 text-center">Current Bounties</h2>

                <div class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                    <input type="text" id="searchBounties" placeholder="Search bounties..."
                        class="w-full md:w-1/2 p-3 rounded-lg bg-gray-900 border border-red-700 text-white focus:ring-2 focus:ring-red-600">
                    <select id="searchPaymentMethod"
                        class="w-full md:w-1/3 p-3 rounded-lg bg-gray-900 border border-red-700 text-white focus:ring-2 focus:ring-red-600">
                        <option value="All">All Payment Methods</option>
                        <option value="In-game Items">In-game Items</option>
                        <option value="Johnny Coins">Johnny Coins</option>
                        <option value="IRL Payments">IRL Payments</option>
                    </select>
                </div>

                <div class="flex space-x-4 mb-6" id="bounties-tabs">
                    <button id="active-bounties-tab"
                        class="px-6 py-3 rounded-lg font-bold transition duration-300 ease-in-out bg-red-700 text-white">
                        Active Bounties (<span id="active-bounties-count">0</span>)
                    </button>
                    <button id="completed-bounties-tab"
                        class="px-6 py-3 rounded-lg font-bold transition duration-300 ease-in-out bg-gray-800 text-gray-300">
                        Completed Bounties (<span id="completed-bounties-count">0</span>)
                    </button>
                    <button id="activity-log-tab"
                        class="px-6 py-3 rounded-lg font-bold transition duration-300 ease-in-out bg-gray-800 text-gray-300">
                        Activity Log
                    </button>
                </div>

                <div id="active-bounties-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <p id="no-active-bounties" class="text-gray-400 col-span-full text-center hidden">No active bounties found.</p>
                    <div id="active-bounties-container" class="col-span-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="completed-bounties-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 hidden">
                    <p id="no-completed-bounties" class="text-gray-400 col-span-full text-center hidden">No completed bounties found.</p>
                    <div id="completed-bounties-container" class="col-span-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="activity-log-list" class="hidden bg-gray-900 p-6 rounded-lg shadow-inner border border-red-700">
                    <h4 class="text-xl font-bold text-red-400 mb-4">Recent Activity</h4>
                    <div id="activity-log-container" class="space-y-4">
                        <p id="no-activity" class="text-gray-400 text-center hidden">No recent activity to display.</p>
                        </div>
                </div>
            </section>

            <section class="text-center mt-8">
                <button id="admin-login-btn"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Admin Login
                </button>
            </section>
        </div>
    </main>

    <div id="auth-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="auth-modal-title" class="text-2xl font-bold text-red-400 mb-4 text-center">Login</h3>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="authEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="authEmail"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                        required />
                </div>
                <div class="mb-6">
                    <label for="authPassword" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="authPassword"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                        required />
                </div>
                <p id="auth-error" class="text-red-500 text-sm text-center hidden mb-4"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-auth-btn"
                        class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Cancel
                    </button>
                    <button type="submit" id="auth-submit-btn"
                        class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Login
                    </button>
                </div>
                <button type="button" id="toggle-auth-mode-btn"
                    class="w-full text-center text-red-300 hover:text-red-200 mt-4 text-sm">
                    Don't have an account? Register here.
                </button>
            </form>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-red-400 mb-4 text-center">Admin Login</h3>
            <div class="mb-4">
                <label for="adminUsernameInput" class="block text-gray-300 text-sm font-bold mb-2">
                    Username:
                </label>
                <input type="text" id="adminUsernameInput"
                    class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                    required />
            </div>
            <div class="mb-6">
                <label for="adminPasswordInput" class="block text-gray-300 text-sm font-bold mb-2">
                    Password:
                </label>
                <input type="password" id="adminPasswordInput"
                    class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                    required />
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-admin-login-btn"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Cancel
                </button>
                <button type="button" id="confirm-admin-login-btn"
                    class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Login
                </button>
            </div>
        </div>
    </div>

    <div id="edit-bounty-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-red-400 mb-4 text-center">Edit Bounty</h3>
            <form id="edit-bounty-form">
                <input type="hidden" id="editBountyId" />
                <div class="mb-4">
                    <label for="editTargetPlayer" class="block text-gray-300 text-sm font-bold mb-2">
                        Target Player Name:
                    </label>
                    <input type="text" id="editTargetPlayer"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                        required />
                </div>
                <div class="mb-4">
                    <label for="editAmount" class="block text-gray-300 text-sm font-bold mb-2">
                        Bounty Amount:
                    </label>
                    <input type="number" id="editAmount" min="1"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                        required />
                </div>
                <div class="mb-4">
                    <label for="editRewardType" class="block text-gray-300 text-sm font-bold mb-2">
                        Reward Type:
                    </label>
                    <input type="text" id="editRewardType"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600"
                        placeholder="What are you rewarding (USD, Scrap, JohnnyCoin etc.)"
                        required />
                </div>
                <div class="mb-4">
                    <label for="editReason" class="block text-gray-300 text-sm font-bold mb-2">
                        Reason for Bounty:
                    </label>
                    <textarea id="editReason" rows="3"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600 resize-y"
                        required></textarea>
                </div>
                <div class="mb-6">
                    <label for="editPaymentMethod" class="block text-gray-300 text-sm font-bold mb-2">
                        Preferred Payment Method:
                    </label>
                    <select id="editPaymentMethod"
                        class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white focus:ring-2 focus:ring-red-600">
                        <option value="In-game Items">In-game Items</option>
                        <option value="Johnny Coins">Johnny Coins</option>
                        <option value="IRL Payments">IRL Payments</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-edit-bounty-btn"
                        class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-red-400 mb-4 text-center">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6 text-center">
                Are you sure you want to delete this bounty? This action cannot be undone.
            </p>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-delete-btn"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Cancel
                </button>
                <button type="button" id="confirm-delete-btn"
                    class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div id="disable-bounty-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-red-400 mb-4 text-center">Disable Bounty</h3>
            <p class="text-gray-300 mb-4 text-center">
                Please provide a reason for disabling this bounty.
            </p>
            <textarea id="disableReasonInput"
                placeholder="Reason for disablement (e.g., Creator requested, invalid bounty, completed out-of-site)"
                rows="4"
                class="w-full p-3 rounded-lg bg-gray-950 border border-red-700 text-white placeholder-red-200 focus:ring-2 focus:ring-red-600 focus:border-transparent mb-4 resize-y"></textarea>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-disable-btn"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Cancel
                </button>
                <button type="button" id="confirm-disable-btn"
                    class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                    Confirm Disable
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, onValue, off, get, child } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // User-provided Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCcAUdGbyBkZuP9i-s7ybHrH-LVJzxQkbU",
            authDomain: "johnny3x-bounties.firebaseapp.com",
            projectId: "johnny3x-bounties",
            storageBucket: "johnny3x-bounties.firebasestorage.app",
            messagingSenderId: "41052099325",
            appId: "1:41052099325:web:6921a7ad893024f3622494"
        };

        // Ensure these global variables are available in the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Define your preset Discord Webhook URL here
        const PRESET_DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1392503480412803152/JQoXoY7rT9FiTc5dIisfCtofWASmvblItwgxcFf5pQMpAS6KU7AdG5Vh8rO51xeZS3kg"; // <<< REMEMBER TO CHANGE THIS FOR PRODUCTION!

        // Hardcoded Admin Credentials (for demonstration purposes only - NOT secure for production)
        const ADMIN_USERNAME = "j3admin";
        const ADMIN_PASSWORD = "j3staffpassword";

        // Firebase App and Services
        let app;
        let db;
        let auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage("Firebase initialization failed. Please check your environment setup.", "error");
        }

        // Global State Variables
        let bounties = [];
        let firebaseUid = null;
        let userEmail = ''; // Stores user's email
        let authReady = false;
        let isLoading = true;
        let isAdmin = false;
        let currentBountyToEdit = null;
        let bountyToDeleteId = null;
        let bountyToDisableId = null;
        let isRegisterMode = false; // State for auth modal (login/register)

        // --- Utility Functions ---

        function showMessage(msg, type) {
            const msgContainer = document.getElementById('message-container');
            if (!msgContainer) return;
            msgContainer.textContent = msg;
            msgContainer.classList.remove('hidden', 'bg-green-700', 'bg-red-700');
            if (type === 'success') {
                msgContainer.classList.add('bg-green-700');
            } else {
                msgContainer.classList.add('bg-red-700');
            }
            setTimeout(() => {
                msgContainer.classList.add('hidden');
            }, 5000);
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('hidden');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }

        function updateLoadingState() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const mainContent = document.getElementById('main-content');
            if (!loadingIndicator || !mainContent) return;

            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                mainContent.classList.add('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        function updateLoginStatus() {
            const statusDiv = document.getElementById('user-login-status');
            if (!statusDiv) return;

            if (firebaseUid) {
                statusDiv.innerHTML = `
                    <p class="text-gray-300">
                        Logged in as: <span class="font-mono text-red-300">${userEmail || firebaseUid}</span>
                        ${isAdmin ? '<span class="ml-2 px-2 py-1 bg-red-600 rounded-md text-xs font-bold">ADMIN</span>' : ''}
                        <button id="logout-btn" class="mt-4 ml-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                            Logout
                        </button>
                    </p>
                `;
                document.getElementById('authenticated-sections')?.classList.remove('hidden');
                document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            } else {
                statusDiv.innerHTML = `
                    <p class="text-gray-300 mb-4">
                        Please log in or register to create or manage bounties.
                    </p>
                    <button id="login-register-btn"
                        class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Login / Register
                    </button>
                `;
                document.getElementById('authenticated-sections')?.classList.add('hidden');
                document.getElementById('login-register-btn')?.addEventListener('click', handleLoginRegisterClick);
            }
        }

        // New function to create activity log entries
        function createActivityLogEntry(message, timestamp) {
            const entry = document.createElement('div');
            entry.className = 'bg-gray-800 p-3 rounded-md border border-gray-700 flex items-center justify-between';
            entry.innerHTML = `
                <p class="text-gray-300 text-sm">${message}</p>
                <span class="text-gray-500 text-xs">${new Date(timestamp).toLocaleString()}</span>
            `;
            return entry;
        }

        // New function to render activity log
        function renderActivityLog() {
            const activityContainer = document.getElementById('activity-log-container');
            const noActivity = document.getElementById('no-activity');
            if (!activityContainer || !noActivity) return;

            activityContainer.innerHTML = ''; // Clear previous entries
            const activityLog = [];

            bounties.forEach(bounty => {
                if (bounty.createdAt) {
                    activityLog.push({
                        timestamp: bounty.createdAt,
                        message: `Bounty for "${bounty.targetPlayer}" created by ${bounty.createdByEmail || 'Unknown User'}.`,
                        sortTime: new Date(bounty.createdAt).getTime()
                    });
                }
                if (bounty.status === 'claimed' && bounty.claimedAt) {
                    activityLog.push({
                        timestamp: bounty.claimedAt,
                        message: `Bounty for "${bounty.targetPlayer}" claimed by ${bounty.claimedByEmail || 'Unknown User'}.`,
                        sortTime: new Date(bounty.claimedAt).getTime()
                    });
                }
                if (bounty.status === 'disabled' && bounty.disabledAt) {
                    activityLog.push({
                        timestamp: bounty.disabledAt,
                        message: `Bounty for "${bounty.targetPlayer}" disabled. Reason: ${bounty.disabledReason || 'N/A'}.`,
                        sortTime: new Date(bounty.disabledAt).getTime()
                    });
                }
                if (bounty.lastUpdatedAt && bounty.lastUpdatedAt !== bounty.createdAt) { // Only log if different from creation
                    activityLog.push({
                        timestamp: bounty.lastUpdatedAt,
                        message: `Bounty for "${bounty.targetPlayer}" last updated by ${bounty.lastUpdatedBy || 'Unknown User'}.`,
                        sortTime: new Date(bounty.lastUpdatedAt).getTime()
                    });
                }
            });

            // Sort activity by most recent first
            activityLog.sort((a, b) => b.sortTime - a.sortTime);

            if (activityLog.length === 0) {
                noActivity.classList.remove('hidden');
            } else {
                noActivity.classList.add('hidden');
                activityLog.forEach(entry => {
                    activityContainer.appendChild(createActivityLogEntry(entry.message, entry.timestamp));
                });
            }
        }

        function renderBounties() {
            const activeContainer = document.getElementById('active-bounties-container');
            const completedContainer = document.getElementById('completed-bounties-container');
            const noActiveBounties = document.getElementById('no-active-bounties');
            const noCompletedBounties = document.getElementById('no-completed-bounties');

            if (!activeContainer || !completedContainer || !noActiveBounties || !noCompletedBounties) {
                console.warn("Bounty containers not found in DOM yet.");
                return;
            }

            activeContainer.innerHTML = '';
            completedContainer.innerHTML = '';

            const searchTerm = document.getElementById('searchBounties')?.value.toLowerCase() || '';
            const searchPaymentMethod = document.getElementById('searchPaymentMethod')?.value || 'All';

            const filteredAndSortedBounties = bounties.filter(bounty => {
                const matchesSearchTerm = (
                    bounty.targetPlayer.toLowerCase().includes(searchTerm) ||
                    bounty.reason.toLowerCase().includes(searchTerm) ||
                    (bounty.createdByEmail && bounty.createdByEmail.toLowerCase().includes(searchTerm))
                );

                const matchesPaymentMethod = (
                    searchPaymentMethod === 'All' || bounty.paymentMethod === searchPaymentMethod
                );

                return matchesSearchTerm && matchesPaymentMethod;
            });

            const activeBounties = filteredAndSortedBounties.filter(b => b.status === 'active');
            const completedBounties = filteredAndSortedBounties.filter(b => b.status === 'claimed' || b.status === 'disabled');

            document.getElementById('active-bounties-count').textContent = activeBounties.length;
            document.getElementById('completed-bounties-count').textContent = completedBounties.length;

            if (activeBounties.length === 0) {
                noActiveBounties.classList.remove('hidden');
            } else {
                noActiveBounties.classList.add('hidden');
                activeBounties.forEach(bounty => {
                    activeContainer.appendChild(createBountyCard(bounty, 'active'));
                });
            }

            if (completedBounties.length === 0) {
                noCompletedBounties.classList.remove('hidden');
            } else {
                noCompletedBounties.classList.add('hidden');
                completedBounties.forEach(bounty => {
                    completedContainer.appendChild(createBountyCard(bounty, 'completed'));
                });
            }

            renderActivityLog(); // Always render activity log when bounties change
        }

        function createBountyCard(bounty) {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg shadow-inner border ${bounty.status === 'disabled' ? 'bg-gray-800 border-gray-700 opacity-75' : 'bg-gray-950 border-red-700'}`;
            
            const statusColorClass = bounty.status === 'claimed' ? 'bg-gray-700' : (bounty.status === 'disabled' ? 'bg-red-900' : 'bg-red-600');
            const textColorClass = bounty.status === 'disabled' ? 'text-gray-400' : 'text-red-300';
            const amountTextColorClass = bounty.status === 'disabled' ? 'text-gray-500' : 'text-red-200';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold ${textColorClass}">${bounty.targetPlayer}</h3>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColorClass}">
                        ${bounty.status.toUpperCase()}
                    </span>
                </div>
                <p class="text-lg ${amountTextColorClass} mb-2">Amount: ${bounty.amount} <span class="font-normal text-sm">${bounty.rewardType || ''}</span></p>
                <p class="text-gray-300 mb-1">Reason: ${bounty.reason}</p>
                <p class="text-gray-300 mb-3">Payment: ${bounty.paymentMethod}</p>
                <p class="text-xs text-gray-300">
                    Bounty Made: ${new Date(bounty.createdAt).toLocaleString()}
                </p>
                ${bounty.status === 'claimed' ? `
                    <p class="text-xs text-gray-300 mt-1">
                        Claimed.
                    </p>
                ` : ''}
                ${bounty.status === 'disabled' && bounty.disabledReason ? `
                    <p class="text-xs text-red-400 mt-1">
                        Disabled. Reason: ${bounty.disabledReason}
                    </p>
                ` : ''}
                <div class="mt-4 flex justify-end gap-2 bounty-actions">
                    </div>
            `;

            const actionsDiv = card.querySelector('.bounty-actions');

            // Conditional buttons (only if user is logged in)
            if (firebaseUid) {
                if (firebaseUid === bounty.createdByUid && bounty.status === 'active') { // Only creator can edit active bounties
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm';
                    editBtn.onclick = () => handleEditClick(bounty);
                    actionsDiv.appendChild(editBtn);
                }
                if (bounty.status === 'active' && firebaseUid !== bounty.createdByUid) { // Only non-creators can claim active bounty
                    const claimBtn = document.createElement('button');
                    claimBtn.textContent = 'Claim';
                    claimBtn.className = 'bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm';
                    claimBtn.onclick = () => handleClaimBounty(bounty.id, bounty.createdByUid);
                    actionsDiv.appendChild(claimBtn);
                }
                if (isAdmin && bounty.status !== 'disabled') { // Only admin can disable
                    const disableBtn = document.createElement('button');
                    disableBtn.textContent = 'Disable';
                    disableBtn.className = 'bg-orange-700 hover:bg-orange-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm';
                    disableBtn.onclick = () => handleDisableClick(bounty.id);
                    actionsDiv.appendChild(disableBtn);
                }
                if (firebaseUid === bounty.createdByUid || isAdmin) { // Creator or Admin can delete
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm';
                    deleteBtn.onclick = () => handleDeleteClick(bounty.id, bounty.createdByUid);
                    actionsDiv.appendChild(deleteBtn);
                }
            }

            return card;
        }

        // --- Authentication Logic ---

        // Firebase Auth Listener
        document.addEventListener('DOMContentLoaded', () => {
            updateLoadingState(); // Show loading indicator initially

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    firebaseUid = user.uid;
                    userEmail = user.email;
                    authReady = true;
                    console.log("Firebase User authenticated:", firebaseUid, userEmail);

                    try {
                        const userProfileRef = ref(db, `artifacts/${appId}/users/${firebaseUid}/profile`);
                        const snapshot = await get(userProfileRef);
                        if (snapshot.exists() && snapshot.val().isAdmin) {
                            isAdmin = snapshot.val().isAdmin;
                        } else {
                            isAdmin = false;
                        }
                    } catch (error) {
                        console.error("Error fetching user profile/isAdmin:", error);
                        isAdmin = false;
                    }

                    // Attach bounties listener ONLY when user is authenticated
                    const bountiesRef = ref(db, `artifacts/${appId}/public/data/bounties`);
                    off(bountiesRef); // Detach any existing listener first
                    onValue(bountiesRef, (snapshot) => {
                        const data = snapshot.val();
                        const fetchedBounties = [];
                        if (data) {
                            Object.keys(data).forEach(key => {
                                fetchedBounties.push({
                                    id: key,
                                    ...data[key],
                                    createdAt: data[key].createdAt ? new Date(data[key].createdAt) : new Date(),
                                    claimedAt: data[key].claimedAt ? new Date(data[key].claimedAt) : null,
                                    disabledAt: data[key].disabledAt ? new Date(data[key].disabledAt) : null,
                                });
                            });
                        }
                        fetchedBounties.sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));
                        bounties = fetchedBounties;
                        renderBounties();
                    }, (error) => {
                        console.error("Error fetching bounties:", error);
                        showMessage(`Failed to load bounties: ${error.message}`, "error");
                    });
                    console.log("Bounties listener attached for authenticated user.");

                } else { // User is unauthenticated
                    firebaseUid = null;
                    userEmail = '';
                    authReady = true;
                    isAdmin = false;

                    // Detach bounties listener if user logs out
                    const bountiesRef = ref(db, `artifacts/${appId}/public/data/bounties`);
                    off(bountiesRef);
                    bounties = []; // Clear bounties
                    renderBounties(); // Re-render to show empty list

                    console.log("Bounties listener detached due to unauthenticated user.");
                }
                isLoading = false;
                updateLoadingState();
                updateLoginStatus();
            });
        });

        // Handle Login/Register button click
        function handleLoginRegisterClick() {
            isRegisterMode = false; // Default to login mode
            document.getElementById('auth-modal-title').textContent = 'Login';
            document.getElementById('auth-submit-btn').textContent = 'Login';
            document.getElementById('toggle-auth-mode-btn').textContent = "Don't have an account? Register here.";
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('auth-error').classList.add('hidden');
            showModal('auth-modal');
        }

        // Handle Email/Password Login or Register submission
        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const authErrorElement = document.getElementById('auth-error');
            authErrorElement.classList.add('hidden');

            if (!email || !password) {
                authErrorElement.textContent = "Email and password cannot be empty.";
                authErrorElement.classList.remove('hidden');
                return;
            }

            if (isRegisterMode) {
                if (password.length < 6) {
                    authErrorElement.textContent = "Password must be at least 6 characters long.";
                    authErrorElement.classList.remove('hidden');
                    return;
                }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = userCredential.user.uid;

                    await set(ref(db, `artifacts/${appId}/users/${uid}/profile`), {
                        email: email,
                        createdAt: new Date().toISOString()
                    });

                    showMessage("Registration successful! Logged in.", "success");
                    hideModal('auth-modal');
                } catch (error) {
                    let displayMessage = "Registration failed.";
                    if (error.code === 'auth/email-already-in-use') {
                        displayMessage = "This email is already in use. Try logging in.";
                    } else if (error.code === 'auth/invalid-email') {
                        displayMessage = "Invalid email address.";
                    } else if (error.code === 'auth/weak-password') {
                        displayMessage = "Password is too weak. It must be at least 6 characters.";
                    } else {
                        displayMessage = `Registration failed: ${error.message}`;
                    }
                    authErrorElement.textContent = displayMessage;
                    authErrorElement.classList.remove('hidden');
                }
            } else {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Logged in successfully!", "success");
                    hideModal('auth-modal');
                } catch (error) {
                    let displayMessage = "Login failed.";
                    if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        displayMessage = "Invalid email or password.";
                    } else {
                        displayMessage = `Login failed: ${error.message}`;
                    }
                    authErrorElement.textContent = displayMessage;
                    authErrorElement.classList.remove('hidden');
                }
            }
        }

        // Handle Logout
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessage("Logged out successfully!", "success");
            } catch (error) {
                console.error("Error logging out:", error);
                showMessage(`Logout failed: ${error.message}`, "error");
            }
        }

        // Admin Login
        function handleAdminLogin() {
            document.getElementById('adminUsernameInput').value = '';
            document.getElementById('adminPasswordInput').value = '';
            showModal('admin-login-modal');
        }

        function handleAdminLoginAttempt() {
            const username = document.getElementById('adminUsernameInput').value;
            const password = document.getElementById('adminPasswordInput').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdmin = true;
                showMessage("Admin login successful!", "success");
                hideModal('admin-login-modal');
                updateLoginStatus();
                renderBounties();
            } else {
                showMessage("Invalid admin credentials.", "error");
            }
        }

        // --- Bounty Management Logic ---

        // Add a new bounty
        async function handleAddBounty(e) {
            e.preventDefault();
            if (!firebaseUid) {
                showMessage("Please log in first.", "error");
                return;
            }

            const targetPlayer = document.getElementById('targetPlayer').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const rewardType = document.getElementById('rewardType').value.trim(); // NEW
            const reason = document.getElementById('reason').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!targetPlayer || !amount || !rewardType || !reason) { // MODIFIED CONDITION
                showMessage("All fields are required to add a bounty.", "error");
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showMessage("Amount must be a positive number.", "error");
                return;
            }

            const newBounty = {
                targetPlayer: targetPlayer,
                amount: amount,
                rewardType: rewardType, // NEW FIELD
                reason: reason,
                paymentMethod: paymentMethod,
                status: 'active',
                disabled: false,
                disabledReason: '',
                createdAt: new Date().toISOString(),
                createdByUid: firebaseUid,
                createdByEmail: userEmail,
            };

            try {
                const bountiesListRef = ref(db, `artifacts/${appId}/public/data/bounties`);
                const newBountyRef = push(bountiesListRef);
                await set(newBountyRef, newBounty);
                showMessage("Bounty added successfully!", "success");

                // Clear form
                document.getElementById('targetPlayer').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('rewardType').value = ''; // Clear the new field
                document.getElementById('reason').value = '';
                document.getElementById('paymentMethod').value = 'In-game Items';

                // Send Discord webhook alert
                if (PRESET_DISCORD_WEBHOOK_URL && PRESET_DISCORD_WEBHOOK_URL !== "https://discord.com/api/webhooks/1392503480412803152/JQoXoY7rT9FiTc5dIisfCtofWASmvblItwgxcFf5pQMpAS6KU7AdG5Vh8rO51xeZS3kg") {
                    await sendDiscordWebhookAlert(newBounty);
                } else {
                    console.warn("Preset Discord Webhook URL is not configured. Skipping alert.");
                    showMessage("Warning: Preset Discord Webhook URL is not configured. Alerts will not be sent.", "error");
                }
            } catch (error) {
                console.error("Error adding bounty:", error);
                showMessage(`Failed to add bounty: ${error.message}`, "error");
            }
        }

        // Send Discord Webhook Alert
        async function sendDiscordWebhookAlert(bounty) {
            const webhookPayload = {
                content: `ðŸš¨ **NEW BOUNTY ALERT!** ðŸš¨`,
                embeds: [
                    {
                        title: `Bounty on ${bounty.targetPlayer}`,
                        description: `**Amount:** ${bounty.amount} ${bounty.rewardType || ''}\n**Reason:** ${bounty.reason}\n**Payment Method:** ${bounty.paymentMethod}`, // MODIFIED LINE
                        color: 16711680, // Red color
                        fields: [
                            // Removed 'Created By' field to hide poster identity
                            {
                                name: "Status",
                                value: bounty.status,
                                inline: true
                            }
                        ],
                        timestamp: new Date().toISOString(),
                        footer: {
                            text: "Johnny3x Rust Bounty System"
                        }
                    }
                ]
            };

            try {
                const response = await fetch(PRESET_DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(webhookPayload),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Discord webhook failed:", response.status, errorText);
                    showMessage(`Failed to send Discord alert: ${response.status} - ${errorText}`, "error");
                } else {
                    console.log("Discord webhook alert sent successfully!");
                }
            } catch (error) {
                console.error("Error sending Discord webhook:", error);
                showMessage(`Error sending Discord alert: ${error.message}`, "error");
            }
        }

        // Claim a bounty
        async function handleClaimBounty(bountyId, bountyCreatorUid) {
            if (!firebaseUid) {
                showMessage("Please log in first.", "error");
                return;
            }
            // User cannot claim their own bounty
            if (firebaseUid === bountyCreatorUid) {
                showMessage("You cannot claim your own bounty.", "error");
                return;
            }

            try {
                const bountyRef = ref(db, `artifacts/${appId}/public/data/bounties/${bountyId}`);
                await update(bountyRef, {
                    status: 'claimed',
                    claimedByUid: firebaseUid,
                    claimedByEmail: userEmail,
                    claimedAt: new Date().toISOString(),
                });
                showMessage("Bounty claimed successfully!", "success");
            } catch (error) {
                console.error("Error claiming bounty:", error);
                showMessage(`Failed to claim bounty: ${error.message}`, "error");
            }
        }

        // Handle Edit Bounty
        function handleEditClick(bounty) {
            if (firebaseUid !== bounty.createdByUid) {
                showMessage("You can only edit bounties that you have created.", "error");
                return;
            }
            currentBountyToEdit = bounty;
            document.getElementById('editBountyId').value = bounty.id;
            document.getElementById('editTargetPlayer').value = bounty.targetPlayer;
            document.getElementById('editAmount').value = bounty.amount;
            document.getElementById('editRewardType').value = bounty.rewardType || ''; // NEW (add || '' for older bounties)
            document.getElementById('editReason').value = bounty.reason;
            document.getElementById('editPaymentMethod').value = bounty.paymentMethod;
            showModal('edit-bounty-modal');
        }

        async function handleUpdateBounty(e) {
            e.preventDefault();
            if (!currentBountyToEdit || !firebaseUid) {
                showMessage("Error: Not authorized or bounty not selected.", "error");
                return;
            }
            if (firebaseUid !== currentBountyToEdit.createdByUid) {
                showMessage("You can only edit bounties that you have created.", "error");
                hideModal('edit-bounty-modal');
                return;
            }

            const editedBountyId = document.getElementById('editBountyId').value;
            const editedTargetPlayer = document.getElementById('editTargetPlayer').value.trim();
            const editedAmount = parseFloat(document.getElementById('editAmount').value);
            const editedRewardType = document.getElementById('editRewardType').value.trim(); // NEW
            const editedReason = document.getElementById('editReason').value.trim();
            const editedPaymentMethod = document.getElementById('editPaymentMethod').value;

            if (!editedTargetPlayer || !editedAmount || !editedRewardType || !editedReason) { // MODIFIED CONDITION
                showMessage("All fields are required to edit a bounty.", "error");
                return;
            }
            if (isNaN(editedAmount) || editedAmount <= 0) {
                showMessage("Amount must be a positive number.", "error");
                return;
            }

            try {
                const bountyRef = ref(db, `artifacts/${appId}/public/data/bounties/${editedBountyId}`);
                await update(bountyRef, {
                    targetPlayer: editedTargetPlayer,
                    amount: editedAmount,
                    rewardType: editedRewardType, // NEW FIELD
                    reason: editedReason,
                    paymentMethod: editedPaymentMethod,
                    lastUpdatedAt: new Date().toISOString(),
                    lastUpdatedBy: userEmail,
                });
                showMessage("Bounty updated successfully!", "success");
                hideModal('edit-bounty-modal');
                currentBountyToEdit = null;
            } catch (error) {
                console.error("Error updating bounty:", error);
                showMessage(`Failed to update bounty: ${error.message}`, "error");
            }
        }

        // Handle Delete Bounty
        async function handleDeleteClick(bountyId, bountyCreatorUid) {
            if (!firebaseUid) {
                showMessage("Please log in first.", "error");
                return;
            }
            if (!isAdmin && firebaseUid !== bountyCreatorUid) {
                showMessage("You can only delete bounties that you have created (or be an admin).", "error");
                return;
            }

            const bountyRefCheck = ref(db, `artifacts/${appId}/public/data/bounties/${bountyId}`);
            const snapshot = await get(bountyRefCheck);
            if (!snapshot.exists()) {
                showMessage("Bounty not found.", "error");
                return;
            }
            if (!isAdmin && snapshot.val().createdByUid !== firebaseUid) {
                showMessage("You can only delete bounties that you have created (or be an admin).", "error");
                return;
            }

            bountyToDeleteId = bountyId;
            showModal('delete-confirm-modal');
        }

        async function handleConfirmDelete() {
            if (!bountyToDeleteId || !firebaseUid) {
                showMessage("Error: Not authorized or bounty not selected for deletion.", "error");
                return;
            }

            try {
                const bountyRef = ref(db, `artifacts/${appId}/public/data/bounties/${bountyToDeleteId}`);
                await remove(bountyRef);
                showMessage("Bounty deleted successfully!", "success");
                hideModal('delete-confirm-modal');
                bountyToDeleteId = null;
            } catch (error) {
                console.error("Error deleting bounty:", error);
                showMessage(`Failed to delete bounty: ${error.message}`, "error");
            }
        }

        // Handle Disable Bounty
        function handleDisableClick(bountyId) {
            if (!isAdmin) {
                showMessage("Only admins can disable bounties.", "error");
                return;
            }
            bountyToDisableId = bountyId;
            document.getElementById('disableReasonInput').value = '';
            showModal('disable-bounty-modal');
        }

        async function handleConfirmDisable() {
            if (!bountyToDisableId || !isAdmin || !firebaseUid) {
                showMessage("Error: Not authorized or bounty not selected for disablement.", "error");
                return;
            }
            const disableReason = document.getElementById('disableReasonInput').value.trim();
            if (!disableReason) {
                showMessage("Please provide a reason for disabling the bounty.", "error");
                return;
            }

            try {
                const bountyRef = ref(db, `artifacts/${appId}/public/data/bounties/${bountyToDisableId}`);
                await update(bountyRef, {
                    status: 'disabled',
                    disabled: true,
                    disabledReason: disableReason,
                    disabledBy: userEmail || firebaseUid,
                    disabledAt: new Date().toISOString(),
                });
                showMessage("Bounty disabled successfully!", "success");
                hideModal('disable-bounty-modal');
                bountyToDisableId = null;
            } catch (error) {
                console.error("Error disabling bounty:", error);
                showMessage(`Failed to disable bounty: ${error.message}`, "error");
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Tab Buttons
            document.getElementById('active-bounties-tab')?.addEventListener('click', () => {
                document.getElementById('active-bounties-list')?.classList.remove('hidden');
                document.getElementById('completed-bounties-list')?.classList.add('hidden');
                document.getElementById('activity-log-list')?.classList.add('hidden'); // NEW: Hide activity log
                document.getElementById('active-bounties-tab')?.classList.replace('bg-gray-800', 'bg-red-700');
                document.getElementById('active-bounties-tab')?.classList.replace('text-gray-300', 'text-white');
                document.getElementById('completed-bounties-tab')?.classList.replace('bg-red-700', 'bg-gray-800');
                document.getElementById('completed-bounties-tab')?.classList.replace('text-white', 'text-gray-300');
                document.getElementById('activity-log-tab')?.classList.replace('bg-red-700', 'bg-gray-800'); // NEW: Reset activity tab
                document.getElementById('activity-log-tab')?.classList.replace('text-white', 'text-gray-300'); // NEW: Reset activity tab
            });

            document.getElementById('completed-bounties-tab')?.addEventListener('click', () => {
                document.getElementById('active-bounties-list')?.classList.add('hidden');
                document.getElementById('completed-bounties-list')?.classList.remove('hidden');
                document.getElementById('activity-log-list')?.classList.add('hidden'); // NEW: Hide activity log
                document.getElementById('completed-bounties-tab')?.classList.replace('bg-gray-800', 'bg-red-700');
                document.getElementById('completed-bounties-tab')?.classList.replace('text-gray-300', 'text-white');
                document.getElementById('active-bounties-tab')?.classList.replace('bg-red-700', 'bg-gray-800');
                document.getElementById('active-bounties-tab')?.classList.replace('text-white', 'text-gray-300');
                document.getElementById('activity-log-tab')?.classList.replace('bg-red-700', 'bg-gray-800'); // NEW: Reset activity tab
                document.getElementById('activity-log-tab')?.classList.replace('text-white', 'text-gray-300'); // NEW: Reset activity tab
            });

            // NEW: Activity Log Tab
            document.getElementById('activity-log-tab')?.addEventListener('click', () => {
                document.getElementById('active-bounties-list')?.classList.add('hidden');
                document.getElementById('completed-bounties-list')?.classList.add('hidden');
                document.getElementById('activity-log-list')?.classList.remove('hidden');

                document.getElementById('active-bounties-tab')?.classList.replace('bg-red-700', 'bg-gray-800');
                document.getElementById('active-bounties-tab')?.classList.replace('text-white', 'text-gray-300');
                document.getElementById('completed-bounties-tab')?.classList.replace('bg-red-700', 'bg-gray-800');
                document.getElementById('completed-bounties-tab')?.classList.replace('text-white', 'text-gray-300');
                document.getElementById('activity-log-tab')?.classList.replace('bg-gray-800', 'bg-red-700');
                document.getElementById('activity-log-tab')?.classList.replace('text-gray-300', 'text-white');
                renderActivityLog(); // Ensure activity log is rendered when tab is clicked
            });


            // Login/Register Modal Buttons
            document.getElementById('login-register-btn')?.addEventListener('click', handleLoginRegisterClick);
            document.getElementById('cancel-auth-btn')?.addEventListener('click', () => hideModal('auth-modal'));
            document.getElementById('auth-form')?.addEventListener('submit', handleAuthSubmit);
            document.getElementById('toggle-auth-mode-btn')?.addEventListener('click', () => {
                isRegisterMode = !isRegisterMode;
                document.getElementById('auth-modal-title').textContent = isRegisterMode ? 'Register' : 'Login';
                document.getElementById('auth-submit-btn').textContent = isRegisterMode ? 'Register' : 'Login';
                document.getElementById('toggle-auth-mode-btn').textContent = isRegisterMode ? 'Already have an account? Login here.' : "Don't have an account? Register here.";
                document.getElementById('auth-error').classList.add('hidden'); // Clear error on mode switch
                document.getElementById('authEmail').value = ''; // Clear fields on mode switch
                document.getElementById('authPassword').value = '';
            });

            // Logout Button (dynamically added, so need to attach listener after updateLoginStatus)
            // This is handled inside updateLoginStatus now.

            // Admin Login Buttons
            document.getElementById('admin-login-btn')?.addEventListener('click', handleAdminLogin);
            document.getElementById('cancel-admin-login-btn')?.addEventListener('click', () => hideModal('admin-login-modal'));
            document.getElementById('confirm-admin-login-btn')?.addEventListener('click', handleAdminLoginAttempt);

            // Add Bounty Form
            document.getElementById('add-bounty-form')?.addEventListener('submit', handleAddBounty);

            // Search and Filter
            document.getElementById('searchBounties')?.addEventListener('input', renderBounties);
            document.getElementById('searchPaymentMethod')?.addEventListener('change', renderBounties);

            // Edit Bounty Modal Buttons
            document.getElementById('edit-bounty-form')?.addEventListener('submit', handleUpdateBounty);
            document.getElementById('cancel-edit-bounty-btn')?.addEventListener('click', () => hideModal('edit-bounty-modal'));

            // Delete Confirmation Modal Buttons
            document.getElementById('cancel-delete-btn')?.addEventListener('click', () => hideModal('delete-confirm-modal'));
            document.getElementById('confirm-delete-btn')?.addEventListener('click', handleConfirmDelete);

            // Disable Bounty Modal Buttons
            document.getElementById('cancel-disable-btn')?.addEventListener('click', () => hideModal('disable-bounty-modal'));
            document.getElementById('confirm-disable-btn')?.addEventListener('click', handleConfirmDisable);
        });
    </script>
</body>
</html>
